\newcommand{\usecase}[5]{{
	\setlength\extrarowheight{5pt}
	\begin{tabular}{|p{3cm}|p{10cm}|}
		\hline
		Actor & #1\\
		\hline
		Entry conditions & #2\\
		\hline
		Event flow & #3\\
		\hline
		Exit condition & #4\\
		\hline
		Exceptions & #5\\
		\hline
	\end{tabular}
}}

\chapter{Specific Requirements}

\section{Use Case Diagrams}
Here are displayed the most important use case diagrams for the various actors.

\begin{figure}[h]
\centering
\includegraphics[width=8cm]{guest_usecase}
\caption{Use case diagram for guest user}
\end{figure}


\begin{figure}[h]
\centering
\includegraphics[width=\textwidth]{active_user_usecase}
\caption{Use case diagram for an active user and the CPMS}
\end{figure}


\begin{figure}[h]
\centering
\includegraphics[width=\textwidth]{payment_provider_usecase}
\caption{Use case diagram for the Payment Service Provider and a Pending User}
\end{figure}

\clearpage


\section{Use Cases}

\begin{enumerate}
	\descitem{User registration}
	\usecase{Guest user}
	{The user is not registered to the system and is on the signup view of the mobile app}
	{
	\begin{enumerate}[1.]
	\item The guest taps on the "Signup" button
	\item The guest fills up the form
	\item The guest taps on the "Submit" button
	\item The system validates the data and create the user profile
	\item The system shows a success message and redirects the guest to the login page
	\end{enumerate}
	}
	{The user profile has been created}
	{
	\begin{enumerate}[1.]
	\item The guest does not insert all the required information
	\item The system is unavailable
	\item The system cannot process the data
	\end{enumerate}
	}
	
	
	\descitem{User login}
	\usecase{Registered user}
	{The user is registered into the system but has to log in first}
	{
	\begin{enumerate}[1.]
	\item The user taps on the "Login" button
	\item The user fills up the form
	\item The user taps on the "Submit" button
	\item The system validates the data and grants access to the user
	\item The system redirects the user to the main page
	\end{enumerate}
	}
	{The user is logged in}
	{
	\begin{enumerate}[1.]
	\item The form data are incomplete or not valid
	\item The system is unavailable
	\item The system cannot process the data
	\end{enumerate}
	}
	
	
	\descitem{View Charge Point locations}
	\usecase{Active user}
	{The user is logged in}
	{
	\begin{enumerate}[1.]
	\item The user taps on the "Explore" button
	\item The system shows a map component centred on the user location
	\item The system shows all the near Charge Point locations
	\item The user taps on a single location
	\item The system shows the details of that location to the user (e.g. availability, connector types...)
	\end{enumerate}
	}
	{The user goes to another section or closes the app}
	{
	\begin{enumerate}[1.]
	\item The system is unavailable
	\end{enumerate}
	}
	
	
	\descitem{Book a Charging session}
	\usecase{Active user}
	{The user is logged in}
	{
	\begin{enumerate}[1.]
	\item The user taps on the "Explore" button
	\item The system shows a map component centred on the user location
	\item The system shows all the near Charge Point locations
	\item The user taps on a single location
	\item The system shows the details of that location to the user (e.g. availability, connector types...)
	\item The user taps on the "Book" button
	\item The system checks the availability with the CPMS
	\item The CPMS confirms the booking to the system
	\item The system shows a confirmation message to the user with the details of the reservation
	\end{enumerate}
	}
	{The user goes to another section or closes the app}
	{
	\begin{enumerate}[1.]
	\item The system is unavailable
	\item The CPMS is unavailable or unreachable
	\item The CPMS reject the booking request
	\end{enumerate}
	}
	
	\descitem{Start a Charging session}
	\usecase{Active user}
	{The user is logged in, has an active booking and is physically at the Charging Point}
	{
	\begin{enumerate}[1.]
	\item The user taps on the "Start Charging" button
	\item The system sends the command to the CPMS
	\item The CPMS confirms the start of the charging session
	\item The system shows a confirmation message to the user
	\end{enumerate}
	}
	{The user goes to another section or closes the app}
	{
	\begin{enumerate}[1.]
	\item The system is unavailable
	\item The CPMS is unavailable or unreachable
	\item The CPMS reject the request
	\end{enumerate}
	}
	
	\descitem{User is notified about the status of the Charging session}
	\usecase{Active user and CPMS}
	{The user is logged in, has an active session and his device is connected to the internet}
	{
	\begin{enumerate}[1.]
	\item The CPMS sends a status update message to the system, informing that the Charging Session is completed
	\item The system sends a notification via the application to the user
	\item The user receives the notification
	\end{enumerate}
	}
	{A notification has been sent}
	{
	\begin{enumerate}[1.]
	\item The system is unavailable
	\item The CPMS is unavailable or unreachable
	\item The CPMS reject the request
	\item The user device is offline
	\item The user has not allowed the app to display notifications
	\end{enumerate}
	}
	
	\descitem{Complete a Charging session and pay for the service}
	\usecase{Active user, CPMS, PSP}
	{The user is logged in, has an active session and is physically at the Charing Point}
	{
	\begin{enumerate}[1.]
	\item The user taps on the "End Charging" button
	\item The system sends the command to the CPMS
	\item The CPMS confirms the end of the charging session and returns the applied tariff
	\item The system shows a success message to the user
	\item In the background the system send a request to the PSP to charge the user for the service
	\end{enumerate}
	}
	{A notification has been sent}
	{
	\begin{enumerate}[1.]
	\item The system is unavailable
	\item The CPMS is unavailable or unreachable
	\item The CPMS reject the request
	\item PSP is unavailable
	\item PSP cannot process the payment
	\end{enumerate}
	}
	
	
\end{enumerate}
\clearpage
\newpage

\section{Sequence Diagrams}
Here are presented the sequence diagrams for the most important use cases. Only the "success" flow is displayed, every exception in the communication flow results in an error message displayed to the user and a request retry between the eMSP and both a CPMS or a PSP with random time with a maximum number of retries based on the request type.\\

\begin{figure}[h]
\centering
\includegraphics[width=13cm\textwidth]{sequence_diagrams/book_session}
\caption{Sequence diagram for the booking process of a new charging session}
\end{figure}


\begin{figure}[h]
\centering
\includegraphics[width=13cm\textwidth]{sequence_diagrams/start_session}
\caption{Sequence diagram for the starting of a charging session}
\end{figure}


\begin{figure}[h]
\centering
\includegraphics[width=13cm\textwidth]{sequence_diagrams/session_notification}
\caption{Sequence diagram for the notification of a relevant update in a charging session}
\end{figure}


\begin{figure}[h]
\centering
\includegraphics[width=13cm\textwidth]{sequence_diagrams/complete_session}
\caption{Sequence diagram for the completion of a charging session and the related payment}
\end{figure}

\clearpage
\newpage


\section{Functional Requirements}

The system should:\\

\begin{tabular}{|c|l|}
	\hline
	\bf{Requirement} & \bf{Description} \\
	\hline
	R1 & Allow Guest User sign-up\\
	\hline
	R2 & Allow Login for Active User\\
	\hline
	R3 & Require verification for email\\
	\hline
	R4 & Require verification for payment method\\
	\hline
	R5 & Allow to get a list of Charge Point\\
	\hline
	R6 & Allow to book a charging session on a specific Charge Point\\
	\hline
	R7 & Allow to start a charging session for a specific booking\\
	\hline
	R8 & Allow to view the list of bookings\\
	\hline
	R9 & Allow to complete a charging session\\
	\hline
	R10 & Forward the payment request to the PSP\\
	\hline
	R11 & Allow to get a list of Charge Point based on the location\\
	\hline
	R13 & Be able to send push notifications to the user device\\
	\hline
	R14 & Periodically poll the various CPMS to cache the data\\
	
	\hline
\end{tabular}

\subsection{Requirements mapping on Goals}
\begin{tabular}{|c|l|}
	\hline
	\bf{Goal} & \bf{Requirements}\\
	\hline
	G1 & R1, R2, R3, R4, R5, R11, R14 \\
	G2 & R1, R2, R3, R4, R5, R6, R8, R11, R14 \\
	G3 & R1, R2, R5, R7, R7, R8, R11, R14 \\
	G4 & R1, R2, R5, R6, R7, R8, R11, R14 \\
	G5 & R1, R2, R5, R6, R7, R8, R11, R13, R14 \\
	G6 & R1, R2, R4, R9, R10, R14 \\
	\hline
\end{tabular}

\clearpage
\newpage

\section{Performance Requirements}
As most of the Charge Points are located in the city centre, where internet connectivity is usually optimal and at high speed, the system does not have special requirements for performances related to bandwidth usage. 
Also, no particular usage spikes are expected at any moment, so server load should be directly connected to the number of users and Charge Points covered by the system.

\section{Design Constraints}
\subsection{Standards compliance}
There are two legal requirements to follow:
GDPR for sensible user data and PS2 / KnowYourCustomer for the payment processing. The second requirement can be fulfilled by selecting a compliant PSP.
Finally, to enable the interconnection with the different CPMS, the OCPI standard shall be followed when implementing the communication protocol and the data structures.

\subsection{Hardware limitations}
No particular hardware are required to use the System, other than an internet-capable smartphone.

\section{Non-functional Requirements}

{
\setlength\extrarowheight{5pt}
\begin{tabular}{|p{3cm}|p{10cm}|}
	\hline
	NFR1 & Reliability impacts the system usage and the related business,
		to keep it as high as possible, fall back servers shall be considered while designing the infrastructure.	\\
	\hline
	NFR2 & Availability also has a huge impact but as this is not a sensible service that needs to be up and running at all time, a good compromise with cost effectiveness can be considered. \\
	\hline
	NFR3 & The basic security standard "de-facto" measurements should be followed, SSL and HTTPS should be enough to offer both security and ease to use.\\
	\hline
\end{tabular}
}

\clearpage
\newpage



\section{External Interface Requirements}
\subsection{User Interfaces}
The user interface for the eMSP system is a mobile application available for both iOS and Android devices.\\
Also, as this will be a publicly available application, accessibility should be considered a priority when designing the interface.

\subsection{Hardware interfaces}
The only hardware required to use the system is a Smartphone running iOS or Android OS, with internet connection capabilities and GPS functionalities.

\subsection{Communication interfaces}
As the system needs to communicate with multiple actors, the following communication interfaces are required:

\begin{enumerate}
	\descitem{CPMS communication:}
	To share data with the various CPMS, an active, low-latency internet connection is needed.\\
   Also is required that the CPMS follows the OCPI protocol.\\
   Is important to remember that to follow the OCPI protocol, our system is required to expose a "PUSH interface" (e.g. an API endpoint that follows the protocol structure) that enables the CPMS to send newer data in real-time.
   
   \descitem{Payment Service Providers:} 
    To process payments a connection with a Payment Service Provider is needed. This connection happens via proprietary API, so custom components are required to connect different providers.
\end{enumerate}


























